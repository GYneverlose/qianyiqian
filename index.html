<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>签一签 v0.4 · 水墨测试版</title>
<style>
  body{margin:0;background:#f6f3ea url('https://images.unsplash.com/photo-1520699514109-9a2583cdd61e?auto=format&fit=crop&w=1400&q=60') center/cover fixed no-repeat; color:#1a1a1a; font-family: "Noto Serif SC", system-ui, serif;}
  header{position:sticky;top:0;background:#ffffffcc;backdrop-filter: blur(6px);border-bottom:1px solid #e6e0cf;padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;font-weight:600;letter-spacing:.2em}
  .paper{max-width:1100px;margin:14px auto;display:grid;grid-template-columns:1.2fr .8fr;gap:14px;padding:0 14px}
  .panel{background:rgba(255,255,255,.9);border:1px solid #e6e0cf;border-radius:12px;padding:14px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
  .btn{display:inline-block;border:1px solid #b89c6b;background:linear-gradient(#fff,#f3ead6);padding:10px 16px;border-radius:10px;cursor:pointer;margin-right:8px}
  .btn:hover{filter:brightness(.98)}
  .inkbtn{border:2px solid #2c2c2c;background:#fff;box-shadow: inset 0 0 0 2px #00000010, 2px 2px 0 #00000020}
  .result{border:1px dashed #d9cfb6;border-radius:10px;padding:12px;background:#fffaf1;margin-top:10px}
  .poem{font-size:18px;color:#834;letter-spacing:1px}
  .tip{color:#444;margin-top:6px}
  .stat{display:inline-flex;gap:6px;background:#fff;border:1px solid #e6e0cf;padding:8px 10px;border-radius:10px;margin-left:8px}
  .grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px}
  .cell{text-align:center;border:1px solid #e6e0cf;border-radius:8px;background:#fff;padding:8px 4px;position:relative}
  .cell .rar{position:absolute;left:4px;top:3px;font-size:10px;color:#888}
  .rar-R{box-shadow: inset 0 0 0 2px #e0e0e0}
  .rar-SR{box-shadow: inset 0 0 0 2px #9dc2a6}
  .rar-SSR{box-shadow: inset 0 0 0 2px #caa85a}
  .rar-SSSR{box-shadow: inset 0 0 0 2px #b26aa2}
  .glow{animation:glow 1.6s ease-in-out infinite alternate}
  @keyframes glow{from{text-shadow:0 0 3px #f6d36b}to{text-shadow:0 0 14px #ffd26f}}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#2c2c2c;color:#fff;padding:10px 16px;border-radius:10px;display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:20}
  .dialog{background:#fffaf1;border:1px solid #e6e0cf;border-radius:12px;max-width:520px;padding:16px 18px;text-align:center}
  .tabs{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  .tab{padding:6px 10px;border:1px solid #c8bfa9;border-radius:999px;cursor:pointer;background:#fff}
  .tab.active{background:#f3ead6}
  .idiom{display:flex;justify-content:space-between;border:1px solid #e6e0cf;background:#fff;border-radius:10px;padding:8px 10px;margin-top:6px}
  .idiom.done{background:#f4fff4;border-color:#a6d8a6}
  small.disclaimer{color:#777}
</style>
</head>
<body>
<header>
  <div><h1>签 一 签 · 水墨测  v0.4</h1>
  <small class="disclaimer">签文非注定，仅供参考，命运未定，信念自身。</small></div>
  <div>
    <span class="stat">命运值：<b id="mv">0</b></span>
    <span class="stat">金稻：<b id="gold">0</b>｜日产：<b id="gyield">0</b></span>
  </div>
</header>

<div class="paper">
  <div class="panel">
    <div class="tabs" id="pools"></div>
    <div class="panel" style="background:#fffef7;border-style:dashed">
      <div class="btn inkbtn" id="ritualBtn">摇签前的仪式</div>
      <div class="btn inkbtn" id="drawBtn">摇签</div>
      <div class="btn inkbtn" id="redoBtn">我重签（订阅模拟）</div>
      <div class="result" id="result" style="display:none">
        <div class="poem" id="poem"></div>
        <div class="tip" id="tip"></div>
        <div class="tip">签级：<span id="tier"></span>｜命运值变化：<b id="mvDelta"></b></div>
      </div>
    </div>

    <div class="panel">
      <h3>抽字卡</h3>
      <div>
        <span class="btn inkbtn" id="drawCard">抽一张</span>
        <small>（命运值 -10）</small>
      </div>
      <div id="cardHint" class="tip"></div>
      <div class="grid" id="inv"></div>
    </div>
  </div>

  <div class="panel">
    <h3>🏯 藏经阁</h3>
    <div id="idiomBox"></div>
    <div style="margin-top:10px">
      <span class="btn inkbtn" id="harvest">收割金稻</span>
      <small>24h 冷却，上次：<span id="lastHarvest">—</span></small>
    </div>
  </div>
</div>

<div class="modal" id="ritual">
  <div class="dialog">
    <h3>仪式 · 静心三息</h3>
    <p>闭上眼，默想你想询问的事。吸——呼——三次。</p>
    <p>当你准备好了，轻点下面的按钮开始摇签。</p>
    <div class="btn" id="startRitual">开始摇签</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<audio id="s_bell" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7f9e3b8b35.mp3?filename=small-bell-99307.mp3" preload="auto"></audio>
<audio id="s_qin" src="https://cdn.pixabay.com/download/audio/2021/09/07/audio_f4f4a9f3e3.mp3?filename=soft-ambience-107997.mp3" preload="auto"></audio>
<audio id="s_coin" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_ae5bff8e33.mp3?filename=coin-collect-retro-8-bit-sound-2021-1-99402.mp3" preload="auto"></audio>

<script>
const POOLS = {"综合": {"weights": {"上上签": 0.1, "上签": 0.2, "中签": 0.4, "下签": 0.2, "下下签": 0.1}, "items": {"上上签": [{"mv": 3, "poem": "风暖自开花，喜事悄然落。", "tip": "今天可能会有点小确幸，别错过小角落里的好事。"}, {"mv": 3, "poem": "心定气自浮，步稳事自成。", "tip": "保持今天的节奏感，福气会来找你。"}, {"mv": 3, "poem": "晴空渡白羽，好风助飞行。", "tip": "今天你特别适合做推进类的事，不妨主动一点。"}, {"mv": 3, "poem": "灵光照心处，百事皆可谈。", "tip": "想不通的东西，今天突然有机会豁然开朗。"}, {"mv": 3, "poem": "人和气亦和，行走皆得宜。", "tip": "你与环境今天相处得刚刚好，是个平顺顺心日。"}], "上签": [{"mv": 2, "poem": "花开半枝香，留白亦成诗。", "tip": "有些事不用做到满，留一点空间反而更好。"}, {"mv": 2, "poem": "闲云不定向，亦随风悠然。", "tip": "放松一点，今天的变化都是有利的。"}, {"mv": 2, "poem": "未问先知意，一语拨千心。", "tip": "今天特别适合沟通与联络，有人可能等着你开口。"}, {"mv": 2, "poem": "小雨润无声，润物在无形。", "tip": "默默努力的事开始有了微妙的反馈，不妨继续坚持。"}, {"mv": 2, "poem": "路绕非迷途，回身亦是福。", "tip": "改变计划不是坏事，灵活会带来转机。"}], "中签": [{"mv": 1, "poem": "晨光尚淡，未辨山形。", "tip": "今天不要急着得出结论，有些事还没浮现出来。"}, {"mv": 1, "poem": "雾重天犹在，心静自分明。", "tip": "感觉不明朗时，不动也是一种智慧。"}, {"mv": 1, "poem": "人言多杂，莫听风语。", "tip": "别太在意别人的话，保持自己的判断。"}, {"mv": 1, "poem": "问路无人应，自行亦有途。", "tip": "就算没人给建议，你自己也走得出方向。"}, {"mv": 1, "poem": "水浅未必易渡，事简不必轻视。", "tip": "小事也要认真对待，别因轻松而出错。"}], "下签": [{"mv": 0, "poem": "浮云蔽眼，难辨东西。", "tip": "情绪可能会干扰判断，别冲动做决定。"}, {"mv": 0, "poem": "喜中有疑，勿贪其早。", "tip": "有些好消息可能藏着条件，先看清楚再高兴。"}, {"mv": 0, "poem": "言未成句，已被曲解。", "tip": "今天沟通可能容易出错，慎言。"}, {"mv": 0, "poem": "旧事未净，烦念易生。", "tip": "有些过去的事可能影响你当下，试着断舍离。"}, {"mv": 0, "poem": "灯火不稳，风向多变。", "tip": "今天不太适合做重大决定，宜守不宜攻。"}], "下下签": [{"mv": -1, "poem": "孤舟夜雨，难见前岸。", "tip": "今天若感到孤单或混乱，先照顾好自己的情绪。"}, {"mv": -1, "poem": "言多必失，心急难成。", "tip": "忍一忍，沉默比解释有用。"}, {"mv": -1, "poem": "花谢风仍急，留恋难回温。", "tip": "放下已经无望的事情，是种自我保护。"}, {"mv": -1, "poem": "喜过则哀至，宜缓庆功。", "tip": "有小成就就好，别太招摇。"}, {"mv": -1, "poem": "欲登高台，路多荆棘。", "tip": "今天不适合冒险，有风险的事等一等吧。"}]}}, "财运": {"weights": {"上上签": 0.1, "上签": 0.2, "中签": 0.4, "下签": 0.2, "下下签": 0.1}, "items": {"上上签": [{"mv": 3, "poem": "东风拂袖金气生，财帛暗随福路通。", "tip": "今日若有灵感动，不妨顺势轻轻推。"}, {"mv": 3, "poem": "水到渠成金自聚，不求亦有暗香来。", "tip": "保持状态，好运正在找入口。"}, {"mv": 3, "poem": "鸿运未语已先到，路转财来不觉迟。", "tip": "别急于计划，先稳住你手上的小利。"}, {"mv": 3, "poem": "日暖风柔财运至，不语亦有人相迎。", "tip": "今日适合静候机会，不抢反赢。"}, {"mv": 3, "poem": "天心一念拨云开，横财难挡顺水来。", "tip": "若遇意外小收获，记得留点喜悦给下次。"}], "上签": [{"mv": 2, "poem": "财临有声非大浪，小步缓行也可盈。", "tip": "只要你肯继续，慢也不是坏事。"}, {"mv": 2, "poem": "福星悄照未张扬，微财藏于细节中。", "tip": "注意生活角落，小利往往藏在那。"}, {"mv": 2, "poem": "时机半启门未全，欲进须观天机旋。", "tip": "今天先看不动，比抢先一步更有底气。"}, {"mv": 2, "poem": "福未全开心先定，稳中有取亦为财。", "tip": "小赚小得，别瞧不起稳当的机会。"}, {"mv": 2, "poem": "浮财若现还须守，虚实之间见真机。", "tip": "别被表象诱惑，稳扎最重要。"}], "中签": [{"mv": 1, "poem": "财随心动却不至，行止之间犹未明。", "tip": "若心乱，不如今天不下决定。"}, {"mv": 1, "poem": "市声虽动利难成，宜守不宜攻其锋。", "tip": "今天的你适合低调一点，不适合放手一搏。"}, {"mv": 1, "poem": "路转不明风未止，小停半步亦无伤。", "tip": "不前进也不是失败，是等待节奏对上。"}, {"mv": 1, "poem": "银气未聚心先乏，欲为力小道难通。", "tip": "与其焦虑，不如安静一会儿再看局势。"}, {"mv": 1, "poem": "空转未生实财动，积气待行方为时。", "tip": "别急，等灵感和动力都回来再动手。"}], "下签": [{"mv": 0, "poem": "金光避行财气浅，少动为安勿妄谋。", "tip": "今天适合节流而非开源，别冲动花钱。"}, {"mv": 0, "poem": "风歇财尽市声哑，未可妄动图金枝。", "tip": "趁静时整理一下账户，比乱冲更有用。"}, {"mv": 0, "poem": "谋财不成反失气，强求不若守静心。", "tip": "若事不顺，先退一步，也许能换来别的运气。"}, {"mv": 0, "poem": "小利有损不划算，君子藏器待来时。", "tip": "今天不适合买买买，适合关掉所有促销推送。"}, {"mv": 0, "poem": "天机未透勿强求，暂借空门养财根。", "tip": "做好基本功，比追短财更重要。"}], "下下签": [{"mv": -1, "poem": "破气入宫行失势，动则财散莫强行。", "tip": "越想补救越亏，不如今天什么都别做。"}, {"mv": -1, "poem": "财门未启福星远，空喜一场最为苦。", "tip": "接受今天的“空手而归”，有时是为了反弹力更强。"}, {"mv": -1, "poem": "多欲乱心财路闭，不舍不聚亦为常。", "tip": "想要太多反而捞不到，收一收欲望试试看。"}, {"mv": -1, "poem": "银火微光难点灯，空话难换真金声。", "tip": "少谈理财经，多做家务活，可能更实在。"}, {"mv": -1, "poem": "运低不语福难听，强言反招自心惊。", "tip": "财运走低时，多沉默，多储能，别自我打脸。"}]}}, "感情": {"weights": {"上上签": 0.1, "上签": 0.2, "中签": 0.4, "下签": 0.2, "下下签": 0.1}, "items": {"上上签": [{"mv": 3, "poem": "花未语情已至，风来人亦来。", "tip": "今天若有人主动靠近，不妨慢慢回应。"}, {"mv": 3, "poem": "桃开东墙外，笑语自成双。", "tip": "保持你的自然，吸引力已经在你身上了。"}, {"mv": 3, "poem": "有缘人不远，愿心似风行。", "tip": "给点空间，也许某人已经在向你靠近。"}, {"mv": 3, "poem": "月满人间静，有情自会来。", "tip": "别急着问结果，对的心会自己找你。"}, {"mv": 3, "poem": "眼底藏星辰，心上有人行。", "tip": "如果你有喜欢的人，今天适合主动一点点。"}], "上签": [{"mv": 2, "poem": "情生未定影微明，心事随风近。", "tip": "别急着贴标签，感觉正在慢慢发芽。"}, {"mv": 2, "poem": "一语误红尘，三思方可亲。", "tip": "说话留一口气，别太快谈心底事。"}, {"mv": 2, "poem": "静看花开时，情缘不强求。", "tip": "缓一点，其实不是没回应，是你还没发现。"}, {"mv": 2, "poem": "月下微光照，两心未全通。", "tip": "可以暗示，但别逼问，给彼此点余地。"}, {"mv": 2, "poem": "风约悄然来，情动非表白。", "tip": "有些好感，不说也能被感受到。"}], "中签": [{"mv": 1, "poem": "心湖无波浪，镜中月不深。", "tip": "今天适合清空情绪，别太执着回音。"}, {"mv": 1, "poem": "旧梦未央，情绪尚未归位。", "tip": "不用急着翻旧页，也别着急翻新篇。"}, {"mv": 1, "poem": "欲语还休时，情未到缘未定。", "tip": "观察比冲动重要，说出口之前再等等。"}, {"mv": 1, "poem": "三分喜意藏，两分迟疑拦。", "tip": "有感觉就承认，但别急着行动。"}, {"mv": 1, "poem": "相思未满月，相处不成诗。", "tip": "感情这事，不确定就别强行浪漫。"}], "下签": [{"mv": 0, "poem": "缘路多歧口，心门闭未开。", "tip": "今天可能不太适合谈情说爱，冷静优先。"}, {"mv": 0, "poem": "情线绕指乱，旧事上心头。", "tip": "你还没放下之前的故事，别骗自己。"}, {"mv": 0, "poem": "喜未实情未真，虚声最动人。", "tip": "有人对你太好，反而值得多留心。"}, {"mv": 0, "poem": "半途无人候，空阶夜自深。", "tip": "别为了孤单而联络，不值得。"}, {"mv": 0, "poem": "言浅情未透，相顾两不明。", "tip": "想清楚你是喜欢他，还是喜欢被喜欢。"}], "下下签": [{"mv": -1, "poem": "心有风雷动，人无应答声。", "tip": "情绪别白给，今天的回应不会如你预期。"}, {"mv": -1, "poem": "爱欲若执念，越求越成空。", "tip": "别盯着一个没回应的人，看回自己。"}, {"mv": -1, "poem": "话止唇边冷，情落纸上灰。", "tip": "想说的别说了，留给愿意听的人。"}, {"mv": -1, "poem": "缘起无门，心动错时。", "tip": "不代表没缘，只是不在今天。"}, {"mv": -1, "poem": "情深不寿，执者最伤。", "tip": "停一下，别再反复伤自己。"}]}}, "事业": {"weights": {"上上签": 0.1, "上签": 0.2, "中签": 0.4, "下签": 0.2, "下下签": 0.1}, "items": {"上上签": [{"mv": 3, "poem": "风起云扬展大志，万机俱备顺时乘。", "tip": "大局已就绪，适合推进重要计划。"}, {"mv": 3, "poem": "锦路开前程，贵人护左右。", "tip": "有人正暗中支持你，不妨大胆一点。"}, {"mv": 3, "poem": "星沉策动千机转，一语惊人四座听。", "tip": "你今天的话、行动，很可能成为关键影响点。"}, {"mv": 3, "poem": "跃马横空志不凡，万仞高楼起足间。", "tip": "不怕从低开始，有势就有未来。"}, {"mv": 3, "poem": "日照长川金气动，一念启行转乾坤。", "tip": "若你正犹豫一事，今日可以定夺了。"}], "上签": [{"mv": 2, "poem": "水清石见道初明，不争自有路浮光。", "tip": "越清晰自己要什么，越容易走出好局。"}, {"mv": 2, "poem": "闲云虽缓行终稳，不速亦胜争先人。", "tip": "别怕进展慢，你走的比你以为的远。"}, {"mv": 2, "poem": "藏锋未显意已成，后发之势可图强。", "tip": "你还没爆发而已，实力已经慢慢聚起。"}, {"mv": 2, "poem": "万象未动心先静，有机可待勿妄行。", "tip": "看清形势才动，是你最好的节奏。"}, {"mv": 2, "poem": "山高望远途未穷，稳字当头福自生。", "tip": "今天不要赌局，宜守为上。"}], "中签": [{"mv": 1, "poem": "局开三分路，心乱难知机。", "tip": "如果你现在看不清方向，先休整一天。"}, {"mv": 1, "poem": "谋事初成未成局，一举一动皆为根。", "tip": "小决定也有影响，细节值得你重看一遍。"}, {"mv": 1, "poem": "志动而路静，行迟非失也。", "tip": "别误会“没动静”是坏事，有时候是在铺排。"}, {"mv": 1, "poem": "一念未定百事难，先求心定再谈图。", "tip": "今天的关键，是想清楚而不是做决定。"}, {"mv": 1, "poem": "虚名满席空坐客，实事落地无人知。", "tip": "别被夸奖冲昏头，专注实际。"}], "下签": [{"mv": 0, "poem": "前路多雾，莫执旧灯。", "tip": "你原本的计划不适用了，先暂停。"}, {"mv": 0, "poem": "谋而难动，力不敌时。", "tip": "不是你不行，是时机还没来，先等。"}, {"mv": 0, "poem": "强行破局反结绳，宜退半步换明灯。", "tip": "硬冲的事今天做不了，不如换个切口。"}, {"mv": 0, "poem": "局未全成欲速败，积力待时自化龙。", "tip": "再多一点准备，可能避免一次翻车。"}, {"mv": 0, "poem": "空谈造局无实器，成事非口中来。", "tip": "今天要落地，别只讲理想。"}], "下下签": [{"mv": -1, "poem": "前缘难续后局未生，动之则伤。", "tip": "旧路走不通，新路还没出现，今天不适合决定方向。"}, {"mv": -1, "poem": "火候未熟急断则焦，徒添烦忧。", "tip": "如果你在考虑跳槽、辞职，今天最好先忍一忍。"}, {"mv": -1, "poem": "力散志浮百事难成，一静而得全局安。", "tip": "别胡思乱想，让自己沉下来是首要。"}, {"mv": -1, "poem": "人心乖舛，是非暗涌。", "tip": "职场今天可能暗涌多，少说话多看人。"}, {"mv": -1, "poem": "利尽道散，不如归心。", "tip": "有些合作或许该收手，别浪费力气在无效事上。"}]}}};
const CARDS = [{"ch": "心", "rar": "R"}, {"ch": "想", "rar": "R"}, {"ch": "事", "rar": "R"}, {"ch": "成", "rar": "R"}, {"ch": "万", "rar": "R"}, {"ch": "如", "rar": "R"}, {"ch": "意", "rar": "R"}, {"ch": "东", "rar": "R"}, {"ch": "海", "rar": "R"}, {"ch": "步", "rar": "R"}, {"ch": "高", "rar": "R"}, {"ch": "升", "rar": "R"}, {"ch": "腾", "rar": "R"}, {"ch": "四", "rar": "R"}, {"ch": "全", "rar": "R"}, {"ch": "双", "rar": "R"}, {"ch": "气", "rar": "R"}, {"ch": "洋", "rar": "R"}, {"ch": "福", "rar": "SR"}, {"ch": "财", "rar": "SR"}, {"ch": "源", "rar": "SR"}, {"ch": "滚", "rar": "SR"}, {"ch": "喜", "rar": "SR"}, {"ch": "禄", "rar": "SSR"}, {"ch": "吉", "rar": "SSR"}, {"ch": "星", "rar": "SSR"}, {"ch": "龙", "rar": "SSR"}, {"ch": "禧", "rar": "SSR"}, {"ch": "麒", "rar": "SSSR"}, {"ch": "麟", "rar": "SSSR"}, {"ch": "祥", "rar": "SSSR"}, {"ch": "呈", "rar": "SSSR"}];
const IDIOMS = [{"name": "心想事成", "chars": ["心", "想", "事", "成"], "tier": "R", "yield": 1}, {"name": "万事如意", "chars": ["万", "事", "如", "意"], "tier": "R", "yield": 1}, {"name": "福如东海", "chars": ["福", "如", "东", "海"], "tier": "SR", "yield": 3}, {"name": "财源滚滚", "chars": ["财", "源", "滚", "滚"], "tier": "SR", "yield": 3}, {"name": "吉星高照", "chars": ["吉", "星", "高", "照"], "tier": "SSR", "yield": 6}, {"name": "步步高升", "chars": ["步", "步", "高", "升"], "tier": "R", "yield": 1}, {"name": "龙腾四海", "chars": ["龙", "腾", "四", "海"], "tier": "SSR", "yield": 6}, {"name": "福禄双全", "chars": ["福", "禄", "双", "全"], "tier": "SSR", "yield": 6}, {"name": "喜气洋洋", "chars": ["喜", "气", "洋", "洋"], "tier": "SR", "yield": 3}, {"name": "麒麟呈祥", "chars": ["麒", "麟", "呈", "祥"], "tier": "SSSR", "yield": 10}];
const rarityWeights = {R:0.7, SR:0.2, SSR:0.09, SSSR:0.01};

const state = {mv:0,gold:0,goldYield:0,inv:{},idiomDone:{},lastHarvest:0,prevDraw:null,canRedo:false,curPool:"综合"};

function save(){ localStorage.setItem("qianyiqian_v04", JSON.stringify(state)); }
function load(){ try{ Object.assign(state, JSON.parse(localStorage.getItem("qianyiqian_v04")||"{}")); }catch(e){} }

function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }
function play(id){ const a=document.getElementById(id); if(!a) return; try{ a.currentTime=0; a.play(); }catch(e){} }

function updateUI(){
  document.getElementById('mv').textContent = state.mv;
  document.getElementById('gold').textContent = state.gold;
  document.getElementById('gyield').textContent = state.goldYield;
  document.getElementById('lastHarvest').textContent = state.lastHarvest? new Date(state.lastHarvest).toLocaleString() : "—";
  renderInv(); renderIdioms();
  // tabs
  const poolsDiv = document.getElementById('pools'); poolsDiv.innerHTML="";
  Object.keys(POOLS).forEach(name=>{
    const b=document.createElement('div'); b.className='tab'+(name===state.curPool?' active':''); b.textContent=name;
    b.addEventListener('click',()=>{ state.curPool=name; updateUI(); save(); });
    poolsDiv.appendChild(b);
  });
  document.getElementById('redoBtn').disabled = !state.canRedo;
  document.getElementById('result').style.display = state.prevDraw? 'block':'none';
}

function pickLevel(weights){
  const r=Math.random(); let acc=0;
  for(const k of Object.keys(weights)){ acc+=weights[k]; if(r<=acc) return k; }
  return "中签";
}
function drawFromPool(name){
  const pool=POOLS[name]||POOLS["综合"];
  const level=pickLevel(pool.weights);
  const arr=pool.items[level];
  const it=arr[Math.floor(Math.random()*arr.length)];
  return Object.assign({level}, it);
}

function onRitual(){
  document.getElementById('ritual').style.display='flex';
  play('s_qin');
}
function onStartRitual(){ document.getElementById('ritual').style.display='none'; onDraw(); }

function onDraw(){
  const res = drawFromPool(state.curPool);
  state.prevDraw = res; state.canRedo=true;
  document.getElementById('poem').textContent = res.poem;
  document.getElementById('tip').textContent = res.tip;
  document.getElementById('tier').textContent = res.level;
  document.getElementById('mvDelta').textContent = (res.mv>=0?'+':'')+res.mv;
  document.getElementById('result').style.display='block';
  play('s_bell'); save(); updateUI();
}

function onAccept(){
  if(!state.prevDraw) return;
  state.mv += state.prevDraw.mv;
  toast('命运值变化 ' + (state.prevDraw.mv>=0?'+':'') + state.prevDraw.mv);
  state.prevDraw=null; state.canRedo=false; save(); updateUI();
}

function onRedo(){
  if(!state.canRedo){ toast('本次已重签过'); return; }
  const res = drawFromPool(state.curPool);
  state.prevDraw=res; state.canRedo=false;
  document.getElementById('poem').textContent = res.poem;
  document.getElementById('tip').textContent = res.tip;
  document.getElementById('tier').textContent = res.level;
  document.getElementById('mvDelta').textContent = (res.mv>=0?'+':'')+res.mv;
  play('s_bell'); save(); updateUI();
}

function weightedRarity(){
  const r=Math.random(); let acc=0;
  for(const k of Object.keys(rarityWeights)){ acc+=rarityWeights[k]; if(r<=acc) return k; }
  return 'R';
}
function drawCard(){
  if(state.mv<10){ toast('命运值不足（需要10）'); return; }
  state.mv -= 10;
  for(let i=0;i<8;i++){ // try a few times
    const rar = weightedRarity();
    const cand = CARDS.filter(c=>c.rar===rar);
    if(cand.length){ const c=cand[Math.floor(Math.random()*cand.length)];
      state.inv[c.ch]=(state.inv[c.ch]||0)+1;
      document.getElementById('cardHint').innerHTML = '获得字卡：<b class="glow">'+c.ch+'</b>（'+c.rar+'）';
      play('s_coin'); break;
    }
  }
  recomputeIdioms(); save(); updateUI();
}

function renderInv(){
  const box=document.getElementById('inv'); box.innerHTML="";
  const order={SSSR:0,SSR:1,SR:2,R:3};
  CARDS.slice().sort((a,b)=> order[a.rar]-order[b.rar] || a.ch.localeCompare(b.ch)).forEach(c=>{
    const d=document.createElement('div'); d.className='cell rar-'+c.rar;
    const cnt=state.inv[c.ch]||0;
    d.innerHTML = '<div class="rar">'+c.rar+'</div><div>'+c.ch+'</div><div style="font-size:12px;color:#777">'+cnt+'</div>';
    box.appendChild(d);
  });
}

function recomputeIdioms(){
  let yieldSum=0;
  for(const id of IDIOMS){
    const need={}; id.chars.forEach(ch=> need[ch]=(need[ch]||0)+1 );
    const hasAll = Object.entries(need).every(([ch,n])=> (state.inv[ch]||0)>=n);
    if(hasAll) state.idiomDone[id.name]=true;
    if(state.idiomDone[id.name]) yieldSum += id.yield;
  }
  state.goldYield = yieldSum;
}

function renderIdioms(){
  const box=document.getElementById('idiomBox'); box.innerHTML="";
  IDIOMS.forEach(id=>{
    const done=!!state.idiomDone[id.name];
    const div=document.createElement('div'); div.className='idiom'+(done?' done':'');
    div.innerHTML = '<div><b>'+id.name+(done?' ✅':'')+'</b><br><small>所需：'+id.chars.join(' ')+' ｜ 点亮 +'+id.yield+' 日产</small></div><div><span class="btn inkbtn">点亮</span></div>';
    const btn=div.querySelector('.btn');
    btn.disabled = done;
    btn.addEventListener('click',()=>{
      const need={}; id.chars.forEach(ch=> need[ch]=(need[ch]||0)+1 );
      const ok = Object.entries(need).every(([ch,n])=> (state.inv[ch]||0)>=n);
      if(!ok){ toast('字卡不足'); return; }
      state.idiomDone[id.name]=true; recomputeIdioms(); save(); updateUI(); play('s_coin'); toast('点亮「'+id.name+'」');
    });
    box.appendChild(div);
  });
}

function harvest(){
  if(state.goldYield<=0){ toast('先点亮一条成语试试'); return; }
  const now=Date.now(), day=24*60*60*1000;
  if(state.lastHarvest && now-state.lastHarvest<day){ const left=Math.ceil((day-(now-state.lastHarvest))/3600000); toast('尚未到收割时间（约 '+left+' 小时后）'); return; }
  state.gold += state.goldYield; state.lastHarvest=now; save(); updateUI(); play('s_coin'); toast('收割成功 +'+state.goldYield+' 金稻');
}

document.addEventListener('DOMContentLoaded', ()=>{
  load(); recomputeIdioms(); updateUI();
  document.getElementById('ritualBtn').addEventListener('click', onRitual);
  document.getElementById('startRitual').addEventListener('click', onStartRitual);
  document.getElementById('drawBtn').addEventListener('click', onDraw);
  document.getElementById('redoBtn').addEventListener('click', onRedo);
  document.getElementById('harvest').addEventListener('click', harvest);
  document.getElementById('drawCard').addEventListener('click', drawCard);
});
</script>
</body>
</html>
